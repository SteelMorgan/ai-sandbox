services:
  agent:
    container_name: ai-agent-sandbox
    build:
      context: .
      dockerfile: Dockerfile
    # Use root as the container process user so entrypoint can chmod the volume.
    user: "0:0"
    volumes:
      - agent-work-sandbox-lite:/workspaces/work
      # Persist entire vscode home across rebuilds (CLI configs, sessions, history, gh auth, etc.)
      - agent-home-global:/home/vscode
    env_file:
      - .env
    secrets:
      - cc_api_key
      - github_token
    # Default: allow sudo. (Restricted profiles can add no-new-privileges.)
    # pids_limit 4096: Electron/Chromium spawn many processes; 512 caused
    # "pthread_create: Resource temporarily unavailable" / "fork: retry".
    pids_limit: 4096
    mem_limit: 8g
    cpus: "4.0"

volumes:
  agent-work-sandbox-lite:
    external: true
  agent-home-global:

secrets:
  cc_api_key:
    file: ../secrets/cc_api_key
  github_token:
    file: ../secrets/github_token
